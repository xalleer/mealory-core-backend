// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Goal {
  weight_loss
  weight_gain
  healthy_eating
  maintain_weight
}

enum AuthProvider {
  local
  google
  apple
}

enum ProductCategory {
  meat
  poultry
  fish
  dairy
  eggs
  vegetables
  fruits
  grains
  pasta
  bakery
  oils
  spices
  sweets
  beverages
  canned
  frozen
  nuts
  other
}

enum MeasurementUnit {
  kg
  g
  l
  ml
  piece
}

enum ShoppingListStatus {
  pending
  in_progress
  completed
}

model User {
  id                String       @id @default(uuid()) @db.Uuid
  email             String       @unique
  password          String?
  name              String
  height            Int?
  weight            Int?
  goal              Goal?
  isFamilyHead      Boolean      @default(false) @map("is_family_head")
  familyId          String?      @db.Uuid @map("family_id")
  familyMemberId    String?      @unique @db.Uuid @map("family_member_id")
  authProvider      AuthProvider @default(local) @map("auth_provider")
  refreshTokenHash  String?      @map("refresh_token_hash")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  family            Family?      @relation("FamilyUsers", fields: [familyId], references: [id])
  familyMember      FamilyMember? @relation("UserFamilyMember", fields: [familyMemberId], references: [id])
  registeredFamilyMember FamilyMember? @relation("FamilyMemberUser")
  createdFamilies   Family[]     @relation("FamilyCreatedBy")
  inventoryItems    Inventory[]

  @@map("users")
}

model Family {
  id                String       @id @default(uuid()) @db.Uuid
  weeklyBudget      Decimal?     @db.Decimal(12, 2) @map("weekly_budget")
  budgetUsed        Decimal      @default(0) @db.Decimal(12, 2) @map("budget_used")
  budgetPeriodStart DateTime?    @db.Date @map("budget_period_start")
  budgetPeriodEnd   DateTime?    @db.Date @map("budget_period_end")
  createdById       String       @db.Uuid @map("created_by")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  createdBy         User         @relation("FamilyCreatedBy", fields: [createdById], references: [id])
  users             User[]       @relation("FamilyUsers")
  members           FamilyMember[]
  menus             Menu[]
  shoppingLists     ShoppingList[]
  inventory         Inventory[]

  @@map("families")
}

model FamilyMember {
  id           String   @id @default(uuid()) @db.Uuid
  familyId     String   @db.Uuid @map("family_id")
  name         String
  userId       String?  @unique @db.Uuid @map("user_id")
  inviteToken  String   @unique @default(uuid()) @db.Uuid @map("invite_token")
  mealTimes    Json?    @map("meal_times")
  allergies    Json?    @map("allergies")
  isRegistered Boolean  @default(false) @map("is_registered")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  family       Family   @relation(fields: [familyId], references: [id])
  user         User?    @relation("FamilyMemberUser", fields: [userId], references: [id])
  invitedUsers User[]   @relation("UserFamilyMember")
  meals        Meal[]

  @@map("family_members")
}

model PasswordReset {
  id        String   @id @default(uuid()) @db.Uuid
  email     String
  otpCode   String   @map("otp_code")
  expiresAt DateTime @map("expires_at")
  isUsed    Boolean  @default(false) @map("is_used")

  @@map("password_resets")
}

model Product {
  id                 String            @id @default(uuid()) @db.Uuid
  name               String
  nameEn             String?           @map("name_en")
  category           ProductCategory
  averagePrice       Decimal           @db.Decimal(10, 2) @map("average_price")
  priceHistory       Json              @map("price_history")
  baseUnit           MeasurementUnit   @map("base_unit")
  standardPackaging  Decimal?          @db.Decimal(10, 3) @map("standard_packaging")
  calories           Int?
  protein            Decimal?          @db.Decimal(6, 2)
  fats               Decimal?          @db.Decimal(6, 2)
  carbs              Decimal?          @db.Decimal(6, 2)
  allergens          Json
  imageUrl           String?           @map("image_url")
  isActive           Boolean           @default(true) @map("is_active")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")

  recipeIngredients  RecipeIngredient[]
  shoppingListItems  ShoppingListItem[]
  inventoryItems     Inventory[]

  @@map("products")
}

model Menu {
  id          String   @id @default(uuid()) @db.Uuid
  familyId    String   @db.Uuid @map("family_id")
  weekStart   DateTime @db.Date @map("week_start")
  weekEnd     DateTime @db.Date @map("week_end")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  family      Family   @relation(fields: [familyId], references: [id])
  days        Day[]
  shoppingLists ShoppingList[]

  @@map("menus")
}

model Day {
  id        String   @id @default(uuid()) @db.Uuid
  menuId    String   @db.Uuid @map("menu_id")
  date      DateTime @db.Date
  dayNumber Int      @map("day_number")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  menu      Menu     @relation(fields: [menuId], references: [id], onDelete: Cascade)
  meals     Meal[]

  @@map("days")
}

enum MealType {
  breakfast
  lunch
  snack
  dinner
}

enum MealStatus {
  pending
  cooking
  completed
  skipped
  auto_skipped
}

model Meal {
  id              String     @id @default(uuid()) @db.Uuid
  dayId           String     @db.Uuid @map("day_id")
  familyMemberId  String?    @db.Uuid @map("family_member_id")
  mealType        MealType   @map("meal_type")
  status          MealStatus @default(pending)
  scheduledTime   DateTime?  @map("scheduled_time")
  completedAt     DateTime?  @map("completed_at")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  day             Day           @relation(fields: [dayId], references: [id], onDelete: Cascade)
  familyMember    FamilyMember? @relation(fields: [familyMemberId], references: [id])
  recipe          Recipe?

  @@map("meals")
}

model Recipe {
  id            String  @id @default(uuid()) @db.Uuid
  mealId        String  @unique @db.Uuid @map("meal_id")
  name          String
  nameEn        String? @map("name_en")
  description   String?
  cookingTime   Int?    @map("cooking_time")
  servings      Int
  calories      Int?
  protein       Decimal? @db.Decimal(6, 2)
  fats          Decimal? @db.Decimal(6, 2)
  carbs         Decimal? @db.Decimal(6, 2)
  instructions  Json
  imageUrl      String? @map("image_url")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  meal          Meal               @relation(fields: [mealId], references: [id], onDelete: Cascade)
  ingredients   RecipeIngredient[]

  @@map("recipes")
}

model RecipeIngredient {
  id         String           @id @default(uuid()) @db.Uuid
  recipeId   String           @db.Uuid @map("recipe_id")
  productId  String           @db.Uuid @map("product_id")
  quantity   Decimal          @db.Decimal(10, 3)
  unit       MeasurementUnit
  createdAt  DateTime         @default(now()) @map("created_at")

  recipe     Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id])

  @@map("recipe_ingredients")
}

model ShoppingList {
  id          String              @id @default(uuid()) @db.Uuid
  menuId      String              @db.Uuid @map("menu_id")
  familyId    String              @db.Uuid @map("family_id")
  status      ShoppingListStatus  @default(pending)
  totalPrice  Decimal             @default(0) @db.Decimal(12, 2) @map("total_price")
  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")

  menu        Menu                @relation(fields: [menuId], references: [id])
  family      Family              @relation(fields: [familyId], references: [id])
  items       ShoppingListItem[]

  @@map("shopping_lists")
}

model ShoppingListItem {
  id              String        @id @default(uuid()) @db.Uuid
  shoppingListId  String        @db.Uuid @map("shopping_list_id")
  productId       String        @db.Uuid @map("product_id")
  quantity        Decimal       @db.Decimal(10, 3)
  unit            MeasurementUnit
  estimatedPrice  Decimal       @db.Decimal(10, 2) @map("estimated_price")
  actualPrice     Decimal?      @db.Decimal(10, 2) @map("actual_price")
  actualQuantity  Decimal?      @db.Decimal(10, 3) @map("actual_quantity")
  isPurchased     Boolean       @default(false) @map("is_purchased")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  shoppingList    ShoppingList  @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)
  product         Product       @relation(fields: [productId], references: [id])

  @@map("shopping_list_items")
}

model Inventory {
  id              String           @id @default(uuid()) @db.Uuid
  familyId        String           @db.Uuid @map("family_id")
  productId       String           @db.Uuid @map("product_id")
  quantity        Decimal          @db.Decimal(10, 3)
  unit            MeasurementUnit
  addedById       String           @db.Uuid @map("added_by")
  expiryDate      DateTime?        @db.Date @map("expiry_date")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  family          Family           @relation(fields: [familyId], references: [id])
  product         Product          @relation(fields: [productId], references: [id])
  addedBy         User             @relation(fields: [addedById], references: [id])

  @@map("inventory")
}
