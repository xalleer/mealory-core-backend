// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Goal {
  weight_loss
  weight_gain
  healthy_eating
  maintain_weight
}

enum AuthProvider {
  local
  google
  apple
}

enum ProductCategory {
  meat
  poultry
  fish
  dairy
  eggs
  vegetables
  fruits
  grains
  pasta
  bakery
  oils
  spices
  sweets
  beverages
  canned
  frozen
  nuts
  other
}

enum MeasurementUnit {
  kg
  g
  l
  ml
  piece
}

model User {
  id                String       @id @default(uuid()) @db.Uuid
  email             String       @unique
  password          String?
  name              String
  height            Int?
  weight            Int?
  goal              Goal?
  isFamilyHead      Boolean      @default(false) @map("is_family_head")
  familyId          String?      @db.Uuid @map("family_id")
  familyMemberId    String?      @unique @db.Uuid @map("family_member_id")
  authProvider      AuthProvider @default(local) @map("auth_provider")
  refreshTokenHash  String?      @map("refresh_token_hash")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  family            Family?      @relation("FamilyUsers", fields: [familyId], references: [id])
  familyMember      FamilyMember? @relation("UserFamilyMember", fields: [familyMemberId], references: [id])
  registeredFamilyMember FamilyMember? @relation("FamilyMemberUser")
  createdFamilies   Family[]     @relation("FamilyCreatedBy")

  @@map("users")
}

model Family {
  id                String       @id @default(uuid()) @db.Uuid
  weeklyBudget      Decimal?     @db.Decimal(12, 2) @map("weekly_budget")
  budgetUsed        Decimal      @default(0) @db.Decimal(12, 2) @map("budget_used")
  budgetPeriodStart DateTime?    @db.Date @map("budget_period_start")
  budgetPeriodEnd   DateTime?    @db.Date @map("budget_period_end")
  createdById       String       @db.Uuid @map("created_by")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  createdBy         User         @relation("FamilyCreatedBy", fields: [createdById], references: [id])
  users             User[]       @relation("FamilyUsers")
  members           FamilyMember[]

  @@map("families")
}

model FamilyMember {
  id           String   @id @default(uuid()) @db.Uuid
  familyId     String   @db.Uuid @map("family_id")
  name         String
  userId       String?  @unique @db.Uuid @map("user_id")
  inviteToken  String   @unique @default(uuid()) @db.Uuid @map("invite_token")
  mealTimes    Json?    @map("meal_times")
  allergies    Json?    @map("allergies")
  isRegistered Boolean  @default(false) @map("is_registered")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  family       Family   @relation(fields: [familyId], references: [id])
  user         User?    @relation("FamilyMemberUser", fields: [userId], references: [id])
  invitedUsers User[]   @relation("UserFamilyMember")

  @@map("family_members")
}

model PasswordReset {
  id        String   @id @default(uuid()) @db.Uuid
  email     String
  otpCode   String   @map("otp_code")
  expiresAt DateTime @map("expires_at")
  isUsed    Boolean  @default(false) @map("is_used")

  @@map("password_resets")
}

model Product {
  id                 String            @id @default(uuid()) @db.Uuid
  name               String
  nameEn             String?           @map("name_en")
  category           ProductCategory
  averagePrice       Decimal           @db.Decimal(10, 2) @map("average_price")
  priceHistory       Json              @map("price_history")
  baseUnit           MeasurementUnit   @map("base_unit")
  standardPackaging  Decimal?          @db.Decimal(10, 3) @map("standard_packaging")
  calories           Int?
  protein            Decimal?          @db.Decimal(6, 2)
  fats               Decimal?          @db.Decimal(6, 2)
  carbs              Decimal?          @db.Decimal(6, 2)
  allergens          Json
  imageUrl           String?           @map("image_url")
  isActive           Boolean           @default(true) @map("is_active")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")

  @@map("products")
}
